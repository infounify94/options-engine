name: ORB Live Engine (NIFTY/BANKNIFTY)

on:
  schedule:
    # Every 5 min during market hours
    # 03:40‚Äì10:10 UTC = 09:10‚Äì15:40 IST
    - cron: "*/5 4-10 * * 1-5"

    # Special trigger exactly at 9:15 IST
    - cron: "45 3 * * 1-5"

  workflow_dispatch:

jobs:
  run-orb-engine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install yfinance pandas numpy

      # üîÅ Auto retry if Yahoo fails
      - name: Run ORB Engine (retry up to 3 times)
        run: |
          for i in 1 2 3
          do
            echo "Attempt $i"
            python engine.py && break
            echo "Retrying in 10 seconds..."
            sleep 10
          done

      - name: Commit & Push JSON
        run: |
          git config user.name "orb-bot"
          git config user.email "bot@github.com"

          git add orb_analysis.json
          git commit -m "Auto update ORB data $(date)" || echo "No changes"

          git pull --rebase || true
          git push || true
