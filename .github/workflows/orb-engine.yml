name: ORB Live Engine (NIFTY/BANKNIFTY)

on:
  schedule:
    # 09:15â€“15:30 IST  = 03:45â€“10:00 UTC
    - cron: "45,50,55 3 * * 1-5"
    - cron: "*/5 4-9 * * 1-5"

  workflow_dispatch:

jobs:
  run-orb-engine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install yfinance pandas numpy requests

      # Retry logic in case Yahoo fails
      - name: Run ORB Engine (retry 3 times if needed)
        run: |
          for i in 1 2 3
          do
            echo "Attempt $i..."
            python engine.py && break
            echo "Retrying in 10 seconds..."
            sleep 10
          done

      # IMPORTANT: This prevents merge conflicts forever
      - name: Commit & Push JSON safely
        run: |
          git config user.name "orb-bot"
          git config user.email "bot@github.com"

          # Always sync with latest repo state
          git fetch origin main
          git reset --hard origin/main

          git add orb_analysis_multi_trade.json
          git commit -m "ðŸ¤– ORB update - $(date)" || echo "No changes"

          git push origin main --force
